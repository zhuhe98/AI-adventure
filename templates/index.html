<!DOCTYPE html>
<html lang="{{ language }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ui.title }} - {{ ui.subtitle }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>✧ {{ ui.title }} ✧</h1>
        </header>

        <div class="main-content">
            <!-- Left Column: Story & Interaction -->
            <div class="story-section">

                <!-- Story Box -->
                <div class="pixel-box">
                    <!-- Image Area -->
                    <div id="image-container" class="image-frame"
                        style="display: {% if story.image_pending or story.image %}flex{% else %}none{% endif %};">
                        <div id="image-loading" class="loading-overlay"
                            style="display:{% if story.image_pending %}flex{% else %}none{% endif %};">
                            <span>{{ ui.image_loading }}<span id="image-dots">...</span></span>
                        </div>
                        <img id="story-image" src="{{ story.image if story.image else '' }}" alt="场景图片"
                            class="story-image" style="display:{% if story.image %}block{% else %}none{% endif %};">
                    </div>

                    <!-- Text Area -->
                    <div class="story-text-box">
                        {% if story.history_text %}
                        <div class="history-text">{{ story.history_text }}</div>
                        {% endif %}
                        <p class="story-text">{{ story.text if story.text else '...' }}</p>
                        <p id="loading-dots" style="display:none; color: var(--accent-color);">{{ ui.loading_text
                            }}<span id="dots">...</span></p>
                    </div>
                </div>

                <!-- Branch Options -->
                <div class="pixel-box branch-section">
                    <h2>{{ ui.response_prompt if story.options else ui.wait_option }}</h2>
                    <div class="options-grid">
                        {% if story.options and story.options|length > 0 %}
                        {% for option in story.options %}
                        <form method="post" action="/next_step" onsubmit="startLoading()">
                            <input type="hidden" name="branch_choice" value="{{ option }}">
                            <button type="submit" class="btn">{{ option }}</button>
                        </form>
                        {% endfor %}
                        {% else %}
                        <form method="post" action="/next_step" onsubmit="startLoading()">
                            <input type="hidden" name="branch_choice" value="{{ ui.wait_option }}">
                            <button type="submit" class="btn btn-secondary">{{ ui.wait_option }}</button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Free Input -->
                <div class="pixel-box">
                    <form class="input-area" method="post" action="/next_step" onsubmit="startLoading()">
                        <input type="text" class="pixel-input" name="player_input"
                            placeholder="{{ ui.input_placeholder }}">
                        <button type="submit" class="btn" style="width: auto;">{{ ui.send_btn }}</button>
                    </form>
                </div>

            </div>

            <!-- Right Column: Characters & Status -->
            <div class="character-panel">
                <div class="pixel-box">
                    <h2 style="text-align: center; margin-bottom: 1rem; color: var(--secondary-color);">{{
                        ui.characters_title }}</h2>
                    <div class="character-list">
                        {% if characters and characters|length > 0 %}
                        {% for c in characters %}
                        <div class="character-card" onclick="openCharacterModal('{{ c.id }}')">
                            <div class="char-avatar">
                                <img src="{{ c.avatar }}" alt="{{ c.name }}"
                                    style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div class="char-info">
                                <h3>{{ c.name }}</h3>
                                <p>{{ c.desc[:20] }}...</p>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div style="text-align: center; color: #999; padding: 1rem;">{{ ui.no_characters }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Controls -->
                <div class="pixel-box">
                    <div class="game-controls"
                        style="border:none; padding:0; margin:0; flex-direction: column; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="toggleHistory()">{{ ui.history_btn }}</button>
                        <button class="btn btn-secondary" onclick="toggleGameMenu()">{{ ui.menu_btn }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Character Modal -->
    <div id="character-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-btn" onclick="closeCharacterModal()">{{ ui.close_btn }}</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Game Menu Modal -->
    <div id="game-menu-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <button class="close-btn" onclick="closeGameMenu()">{{ ui.close_btn }}</button>
            <h2 style="margin-bottom: 2rem; color: var(--secondary-color);">{{ ui.menu_title }}</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 300px; margin: 0 auto;">
                <button class="btn" onclick="showSaveDialog()">{{ ui.save_btn }}</button>
                <button class="btn" onclick="showLoadDialog()">{{ ui.load_btn }}</button>
                <button class="btn">{{ ui.settings_btn }}</button>
                <button class="btn btn-secondary" onclick="location.href='/'">{{ ui.home_btn }}</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-btn" onclick="closeHistoryModal()">{{ ui.close_btn }}</button>
            <h2 style="margin-bottom: 1rem; color: var(--secondary-color);">{{ ui.history_title }}</h2>
            <div style="white-space: pre-wrap; line-height: 1.8; color: var(--text-color);">
                {{ story.full_text if story.full_text else '...' }}
            </div>
        </div>
    </div>

    <!-- Save Dialog Modal -->
    <div id="save-dialog" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px;">
            <button class="close-btn" onclick="closeSaveDialog()">{{ ui.close_btn }}</button>
            <h2 style="margin-bottom: 1.5rem; color: var(--secondary-color);">{{ ui.save_btn }}</h2>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-color);">
                    {% if language == 'zh' %}存档名称：{% else %}セーブ名：{% endif %}
                </label>
                <input type="text" id="save-name-input" class="pixel-input"
                    placeholder="{% if language == 'zh' %}输入存档名称（可选）{% else %}名前を入力（任意）{% endif %}"
                    style="width: 100%;">
            </div>
            <button class="btn" onclick="doSave()" style="width: 100%;">
                {% if language == 'zh' %}确认存档{% else %}保存{% endif %}
            </button>
        </div>
    </div>

    <!-- Load Dialog Modal -->
    <div id="load-dialog" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <button class="close-btn" onclick="closeLoadDialog()">{{ ui.close_btn }}</button>
            <h2 style="margin-bottom: 1.5rem; color: var(--secondary-color);">{{ ui.load_btn }}</h2>
            <div id="save-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Save list will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            const charactersData = {{ characters| tojson | safe
        }};
        const storyData = {{ story| tojson | safe }};
        const imagePending = {% if story and story.image_pending %}true{% else %} false{% endif %};
        const uiTranslations = {{ ui | tojson | safe }};
        initializeGame(charactersData, storyData, imagePending, uiTranslations);
        });
    </script>
</body>

</html>