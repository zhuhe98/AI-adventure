<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星露谷时光咖啡馆 - 文字冒险</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">

        <!-- header -->
        <div class="header">
            <h1>✧ 星露谷时光咖啡馆 ✧</h1>
        </div>

        <div class="main-content">

            <!-- 故事区 -->
            <div class="story-section">

                <!-- story -->
                <div class="story-box">
                    <!-- 上方图片 -->
                    <div id="image-container" style="display: {% if story.image_pending or story.image %}flex{% else %}none{% endif %};">
                        <!-- loading -->
                        <div id="image-loading" style="display:{% if story.image_pending %}block{% else %}none{% endif %};">图片生成中<span id="image-dots"></span></div>
                        <!-- image -->
                        <img id="story-image" src="{{ story.image if story.image else '' }}" alt="场景图片" class="story-image pixel-art" style="display:{% if story.image %}block{% else %}none{% endif %};">
                    </div>

                    <!-- 下方文字 -->
                    <div class="story-content">
                        {% if story.history_text %}
                        <p class="story-history">{{ story.history_text }}</p>
                        <hr class="history-divider">
                        {% endif %}
                        <p class="story-text">{{ story.text if story.text else '欢迎来到星露谷时光咖啡馆，这里的故事正等待你的探索...' }}</p>
                        <p id="loading-dots" style="display:none;">正在生成<span id="dots"></span></p>
                    </div>
                </div>

                <!-- 分支 -->
                <div class="branch-question">
                    <h2>✦ 你想如何回应？ ✦</h2>
                    <div class="branch-options">
                        {% if story.options and story.options|length > 0 %}
                            {% for option in story.options %}
                            <form method="post" action="/next_step" onsubmit="startLoading()">
                                <input type="hidden" name="branch_choice" value="{{ option }}">
                                <button type="submit" class="branch-option">{{ option }}</button>
                            </form>
                            {% endfor %}
                        {% else %}
                            <form method="post" action="/next_step" onsubmit="startLoading()">
                                <input type="hidden" name="branch_choice" value="等待给出选项">
                                <button type="submit" class="branch-option">等待给出选项</button>
                            </form>
                        {% endif %}
                    </div>
                </div>

            </div>

            <!-- 人物区 -->
            <div class="character-section">
                <h2>✦ 人物介绍 ✦</h2>
                <div class="character-list">
                    {% if characters and characters|length > 0 %}
                        {% for c in characters %}
                        <div class="character-item" onclick="openCharacterModal('{{ c.id }}')">
                            <div class="character-header">
                                <div class="character-avatar">
                                    <img src="{{ c.avatar }}" alt="{{ c.name }}" class="pixel-art">
                                </div>
                                <div class="character-name">{{ c.name }}</div>
                            </div>
                            <div class="character-description">{{ c.desc }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="character-item">
                            <div class="character-header">
                                <div class="character-avatar">
                                    <img src="/api/placeholder/100/100" alt="未知角色" class="pixel-art">
                                </div>
                                <div class="character-name">暂无角色</div>
                            </div>
                            <div class="character-description">随着故事的发展，你将会遇到各种有趣的角色...</div>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- 自由输入 -->
        <div class="input-section">
            <form class="input-form" method="post" action="/next_step" onsubmit="startLoading()">
                <input type="text" class="input-field" name="player_input" placeholder="输入你的回应...">
                <button type="submit" class="input-button">发送</button>
            </form>
        </div>

        <!-- 游戏控制 -->
        <div class="game-controls">
            <div class="control-buttons">
                <button class="control-button" onclick="toggleHistory()">历史记录</button>
            </div>
            <div class="game-menu">
                <button class="menu-button" onclick="toggleGameMenu()">菜单</button>
            </div>
        </div>

    </div>

    <!-- 人物详情 modal -->
    <div id="character-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeCharacterModal()">×</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- 游戏菜单 modal -->
    <div id="game-menu-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeGameMenu()">×</span>
            <h3>✧ 游戏菜单 ✧</h3>
            <div class="menu-buttons">
                <button class="menu-option">存档</button>
                <button class="menu-option">读档</button>
                <button class="menu-option">设置</button>
                <button class="menu-option" onclick="location.href='/'">回到标题</button>
            </div>
        </div>
    </div>

    <!-- 历史记录 modal -->
    <div id="history-modal" class="modal" style="display:none;">
        <div class="modal-content history-modal-content">
            <span class="close-button" onclick="closeHistoryModal()">×</span>
            <h3>✧ 故事历史 ✧</h3>
            <div class="history-container">
                <p class="full-history">{{ story.full_text if story.full_text else '故事才刚刚开始...' }}</p>
            </div>
        </div>
    </div>

    <!-- 引入外部 JavaScript 文件 -->
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
        // 使用外部JS文件中定义的初始化函数
        window.addEventListener('DOMContentLoaded', function() {
            // 将后端传递的数据转为 JSON 字符串传递给 JS 函数
            const charactersData = {{ characters|tojson|safe }};
            const storyData = {{ story|tojson|safe }};
            const imagePending = {% if story and story.image_pending %}true{% else %}false{% endif %};

            // 调用初始化函数
            initializeGame(charactersData, storyData, imagePending);
        });
    </script>

</body>

</html>